<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tattoo Concept Generator V6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#1e293b',
                            900: '#0f172a',
                            950: '#020617',
                        },
                        gold: {
                            500: '#eab308',
                            600: '#ca8a04',
                            700: '#a16207',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1e293b; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 4px;
        }
        .glass-panel {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        /* Custom Dropdown Styling */
        .custom-select {
            position: relative;
            cursor: pointer;
        }
        .select-selected {
            background-color: #1e293b;
            border: 1px solid #475569;
            border-radius: 0.5rem;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s;
        }
        .select-selected:hover {
            border-color: #eab308;
        }
        .select-items {
            position: absolute;
            background-color: #0f172a;
            border: 1px solid #475569;
            border-radius: 0.5rem;
            top: 105%;
            left: 0;
            right: 0;
            z-index: 99;
            max-height: 400px; /* Increased height for longer list */
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .select-hide {
            display: none;
        }
        .select-item {
            padding: 12px 16px;
            border-bottom: 1px solid #1e293b;
            display: flex;
            align-items: center;
            transition: background 0.2s;
        }
        .select-item:hover {
            background-color: #1e293b;
            color: #eab308;
        }
        .select-category {
            background-color: #020617;
            color: #94a3b8;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            padding: 8px 16px;
            font-weight: bold;
            border-bottom: 1px solid #1e293b;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .item-icon {
            width: 24px;
            text-align: center;
            margin-right: 12px;
            color: #eab308;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-10 px-4" onclick="closeAllSelect(event)">

    <!-- Main Container -->
    <main class="w-full max-w-5xl glass-panel rounded-2xl shadow-2xl p-6 md:p-8">
        
        <!-- Header -->
        <header class="text-center mb-8 border-b border-slate-700 pb-6">
            <h1 class="text-4xl md:text-5xl font-bold text-white tracking-tight mb-2">
                <i class="fa-solid fa-pen-nib text-gold-500 mr-3"></i>Ink<span class="text-gold-500">Prompt</span>
            </h1>
            <p class="text-slate-400 text-sm md:text-base">Generatore & Restyling Tatuaggi AI (Nano Banana/SDXL)</p>
        </header>

        <!-- Tabs -->
        <div class="flex mb-8 space-x-6 justify-center">
            <button onclick="switchTab('new')" id="tab-new" class="tab-active text-lg font-bold pb-2 uppercase tracking-wide transition-colors border-b-2 border-gold-500 text-gold-500">
                <i class="fa-solid fa-plus-circle mr-2"></i>Nuovo Concept
            </button>
            <button onclick="switchTab('fix')" id="tab-fix" class="tab-inactive text-lg font-bold pb-2 uppercase tracking-wide transition-colors border-b-2 border-transparent text-slate-500 hover:text-slate-300">
                <i class="fa-solid fa-bandage mr-2"></i>Cover-Up / Modifica
            </button>
        </div>

        <!-- Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- LEFT COLUMN: INPUTS -->
            <div class="space-y-6">
                
                <!-- SECTION: NEW DESIGN -->
                <div id="section-new" class="space-y-5">
                    <div>
                        <label class="block text-gold-500 text-xs font-bold mb-2 uppercase tracking-wider">1. Descrivi il Soggetto</label>
                        <textarea id="subjectInput" rows="3" 
                            class="w-full bg-slate-800 border border-slate-600 rounded-lg p-4 text-white placeholder-slate-500 focus:outline-none focus:border-gold-500 transition shadow-inner"
                            placeholder="Es: Un serpente giapponese che avvolge una peonia..."></textarea>
                    </div>
                </div>

                <!-- SECTION: FIX/COVER-UP -->
                <div id="section-fix" class="hidden space-y-5">
                    <!-- Upload -->
                    <div class="border-2 border-dashed border-slate-600 rounded-lg p-6 text-center hover:bg-slate-800/50 transition cursor-pointer relative" onclick="document.getElementById('fileInput').click()">
                        <input type="file" id="fileInput" class="hidden" accept="image/*" onchange="previewImage(event)">
                        <div id="uploadPlaceholder">
                            <i class="fa-solid fa-camera text-3xl text-slate-500 mb-2"></i>
                            <p class="text-slate-400 text-sm">Carica foto attuale</p>
                        </div>
                        <img id="imagePreview" class="hidden max-h-40 mx-auto rounded shadow-lg object-contain" />
                        <button id="removeImageBtn" onclick="removeImage(event)" class="hidden absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600">
                            <i class="fa-solid fa-times text-xs"></i>
                        </button>
                    </div>

                    <!-- Fix Type Custom Select -->
                    <div>
                         <label class="block text-gold-500 text-xs font-bold mb-2 uppercase tracking-wider">Tipo di Intervento</label>
                         <div class="custom-select" id="fixTypeSelect-container">
                            <div class="select-selected" onclick="toggleSelect(event, 'fixTypeSelect-list')">
                                <span><i class="fa-solid fa-circle-question mr-2 text-gold-500"></i> Scegli intervento...</span>
                                <i class="fa-solid fa-chevron-down text-sm"></i>
                            </div>
                            <div id="fixTypeSelect-list" class="select-items select-hide custom-scrollbar">
                                <div class="select-item" onclick="selectOption('fixType', 'coverup', 'Cover Up (Totale)', 'fa-layer-group')">
                                    <i class="fa-solid fa-layer-group item-icon"></i> Cover Up (Totale)
                                </div>
                                <div class="select-item" onclick="selectOption('fixType', 'rework', 'Rework / Restauro', 'fa-wand-magic-sparkles')">
                                    <i class="fa-solid fa-wand-magic-sparkles item-icon"></i> Rework / Restauro
                                </div>
                                <div class="select-item" onclick="selectOption('fixType', 'add', 'Espansione', 'fa-arrows-left-right')">
                                    <i class="fa-solid fa-arrows-left-right item-icon"></i> Espansione
                                </div>
                                <div class="select-item" onclick="selectOption('fixType', 'color', 'Colorize', 'fa-palette')">
                                    <i class="fa-solid fa-palette item-icon"></i> Colorize
                                </div>
                            </div>
                            <input type="hidden" id="fixTypeSelect" value="">
                        </div>
                    </div>

                    <div>
                        <label class="block text-gold-500 text-xs font-bold mb-2 uppercase tracking-wider">Istruzioni Modifica</label>
                        <textarea id="fixInput" rows="2" 
                            class="w-full bg-slate-800 border border-slate-600 rounded-lg p-4 text-white placeholder-slate-500 focus:outline-none focus:border-gold-500 transition shadow-inner"
                            placeholder="Es: Scurisci il fondo per coprire la scritta..."></textarea>
                    </div>
                </div>

                <!-- SHARED CONTROLS -->
                <div class="space-y-6 border-t border-slate-700 pt-6">
                    
                    <!-- Style Custom Select -->
                    <div>
                        <label class="block text-gold-500 text-xs font-bold mb-2 uppercase tracking-wider">Stile Artistico</label>
                        <div class="custom-select" id="styleSelect-container">
                            <div class="select-selected" onclick="toggleSelect(event, 'styleSelect-list')">
                                <span id="styleSelect-display"><i class="fa-solid fa-palette mr-2 text-gold-500"></i> Seleziona Stile...</span>
                                <i class="fa-solid fa-chevron-down text-sm"></i>
                            </div>
                            <div id="styleSelect-list" class="select-items select-hide custom-scrollbar">
                                <!-- Populated via JS -->
                            </div>
                            <input type="hidden" id="styleSelect" value="">
                        </div>
                    </div>

                    <!-- Context & Gender Row -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        
                        <!-- Context Custom Select -->
                        <div>
                            <label class="block text-gold-500 text-xs font-bold mb-2 uppercase tracking-wider">Posizione / Supporto</label>
                            <div class="custom-select" id="contextSelect-container">
                                <div class="select-selected" onclick="toggleSelect(event, 'contextSelect-list')">
                                    <span id="contextSelect-display"><i class="fa-solid fa-compass-drafting mr-2 text-gold-500"></i> Posizione...</span>
                                    <i class="fa-solid fa-chevron-down text-sm"></i>
                                </div>
                                <div id="contextSelect-list" class="select-items select-hide custom-scrollbar">
                                    <!-- Populated via JS -->
                                </div>
                                <input type="hidden" id="contextSelect" value="">
                            </div>
                        </div>

                        <!-- Gender Custom Select -->
                        <div>
                            <label class="block text-slate-400 text-xs font-bold mb-2 uppercase tracking-wider">Anatomia</label>
                             <div class="custom-select" id="genderSelect-container">
                                <div class="select-selected" onclick="toggleSelect(event, 'genderSelect-list')">
                                    <span id="genderSelect-display"><i class="fa-solid fa-mars mr-2 text-gold-500"></i> Uomo</span>
                                    <i class="fa-solid fa-chevron-down text-sm"></i>
                                </div>
                                <div id="genderSelect-list" class="select-items select-hide custom-scrollbar">
                                     <div class="select-item" onclick="selectOption('genderSelect', 'man', 'Uomo', 'fa-mars')">
                                        <i class="fa-solid fa-mars item-icon"></i> Uomo
                                    </div>
                                    <div class="select-item" onclick="selectOption('genderSelect', 'woman', 'Donna', 'fa-venus')">
                                        <i class="fa-solid fa-venus item-icon"></i> Donna
                                    </div>
                                    <div class="select-item" onclick="selectOption('genderSelect', 'neutral', 'Neutro', 'fa-genderless')">
                                        <i class="fa-solid fa-genderless item-icon"></i> Neutro
                                    </div>
                                </div>
                                <input type="hidden" id="genderSelect" value="man">
                            </div>
                        </div>
                    </div>

                    <!-- Eccentricity Slider -->
                    <div class="bg-slate-800/50 p-4 rounded-lg border border-slate-700">
                        <div class="flex justify-between items-end mb-2">
                            <label class="block text-gold-500 text-xs font-bold uppercase tracking-wider">Libertà Artistica AI</label>
                            <span id="sliderValue" class="text-xs text-gold-500 font-mono">Bilanciato (50%)</span>
                        </div>
                        <input type="range" id="eccentricitySlider" min="0" max="100" value="50" class="w-full h-2 bg-slate-600 rounded-lg appearance-none cursor-pointer">
                        <div class="flex justify-between text-xs text-slate-400 mt-2 font-mono">
                            <span>Tecnico/Preciso</span>
                            <span>Visionario/Artistico</span>
                        </div>
                    </div>

                    <!-- Generate Button -->
                    <button onclick="generatePrompt()" 
                        class="w-full bg-gradient-to-r from-gold-600 to-yellow-500 hover:from-yellow-400 hover:to-yellow-300 text-slate-900 font-bold py-4 px-6 rounded-lg shadow-lg transform transition hover:-translate-y-1 active:translate-y-0">
                        <i class="fa-solid fa-wand-magic-sparkles mr-2"></i> Genera Prompt
                    </button>
                </div>
            </div>

            <!-- RIGHT COLUMN: OUTPUT -->
            <div class="flex flex-col h-full bg-slate-950 rounded-xl border border-slate-800 overflow-hidden relative min-h-[400px]">
                <div class="bg-slate-900 px-4 py-3 border-b border-slate-800 flex justify-between items-center">
                    <span class="text-xs font-mono text-slate-400 uppercase">Prompt Ottimizzato</span>
                    <span class="text-xs text-green-500 hidden opacity-0 transition-opacity duration-300" id="copySuccess"><i class="fa-solid fa-check"></i> Copiato!</span>
                </div>
                
                <textarea id="outputPrompt" readonly 
                    class="flex-grow w-full bg-transparent p-6 text-slate-300 font-mono text-sm resize-none focus:outline-none custom-scrollbar leading-relaxed"
                    placeholder="Il tuo prompt apparirà qui..."></textarea>
                
                <div class="p-4 bg-slate-900 border-t border-slate-800 space-y-2">
                     <p class="text-xs text-slate-500 mb-2 italic" id="uploadHint" style="display:none;">
                        <i class="fa-solid fa-info-circle"></i> Usa questo prompt caricando la tua foto nella AI.
                    </p>
                    <button onclick="copyToClipboard()" 
                        class="w-full bg-slate-800 hover:bg-slate-700 text-white font-semibold py-3 px-4 rounded border border-slate-600 transition flex justify-center items-center group">
                        <i class="fa-regular fa-copy mr-2 group-hover:scale-110 transition"></i> Copia prompt
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- DATASETS (Full Restore & Categorized) ---
        
        const stylesData = {
            "Classici & Culturali": [
                { val: "Traditional Old School", icon: "fa-anchor" },
                { val: "Neo-Traditional", icon: "fa-crow" },
                { val: "Tribal", icon: "fa-bullseye" },
                { val: "Polynesian / Maori", icon: "fa-sun" },
                { val: "Irezumi (Japanese)", icon: "fa-dragon" },
                { val: "Celtic", icon: "fa-infinity" }, /* Fixed Icon */
                { val: "Viking / Norse", icon: "fa-shield-halved" },
                { val: "Chicano", icon: "fa-masks-theater" },
                { val: "Henna / Mehndi", icon: "fa-seedling" }
            ],
            "Realismo & Ritrattistica": [
                { val: "Realism Black & Grey", icon: "fa-camera-retro" },
                { val: "Realism Color", icon: "fa-camera" },
                { val: "Portraiture", icon: "fa-user" },
                { val: "Micro Realism", icon: "fa-magnifying-glass" },
                { val: "Botanical Illustration", icon: "fa-leaf" },
                { val: "Animal Realism", icon: "fa-paw" }
            ],
            "Moderno & Grafico": [
                { val: "Geometric", icon: "fa-shapes" },
                { val: "Dotwork / Pointillism", icon: "fa-braille" },
                { val: "Trash Polka", icon: "fa-explosion" },
                { val: "Blackwork", icon: "fa-fill-drip" },
                { val: "Minimalist / Fine Line", icon: "fa-minus" },
                { val: "Single Line", icon: "fa-bezier-curve" },
                { val: "Sketch Style", icon: "fa-pencil" },
                { val: "Blast Over", icon: "fa-layer-group" },
                { val: "Ignorant Style", icon: "fa-face-dizzy" },
                { val: "Script / Lettering", icon: "fa-font" }
            ],
            "Artistico & Astratto": [
                { val: "Watercolor", icon: "fa-droplet" },
                { val: "Surrealism", icon: "fa-eye" },
                { val: "Abstract", icon: "fa-shuffle" },
                { val: "Glitch Art", icon: "fa-bug" },
                { val: "Oil Painting", icon: "fa-brush" },
                { val: "Optical Illusion", icon: "fa-tornado" }
            ],
            "Dark, Horror & Sci-Fi": [
                { val: "Biomechanical", icon: "fa-robot" },
                { val: "Bio-Organic", icon: "fa-bacterium" },
                { val: "Gothic / Dark Art", icon: "fa-church" },
                { val: "Horror", icon: "fa-ghost" },
                { val: "Cyberpunk", icon: "fa-microchip" },
                { val: "Steampunk", icon: "fa-gears" },
                { val: "X-Ray Effect", icon: "fa-bone" }
            ],
            "Effetti & Texture": [
                { val: "White Ink", icon: "fa-snowflake" },
                { val: "Patchwork", icon: "fa-shirt" },
                { val: "Stained Glass", icon: "fa-gem" },
                { val: "Pixel Art", icon: "fa-gamepad" },
                { val: "Woodcut / Etching", icon: "fa-tree" },
                { val: "Embroidery Effect", icon: "fa-star" }
            ]
        };

        const contextData = {
            "Design & Studio": [
                { val: "design_stencil", label: "Stencil (Linee Guida)", type: "stencil", icon: "fa-ruler-combined" },
                { val: "design_white", label: "Flash Sheet (Sfondo Bianco)", type: "flat", icon: "fa-file" },
                { val: "design_transfer", label: "Carta Ettografica", type: "flat", icon: "fa-copy" },
                { val: "design_parchment", label: "Pergamena Vintage", type: "flat", icon: "fa-scroll" },
                { val: "design_digital", label: "iPad / Procreate", type: "flat", icon: "fa-tablet-screen-button" },
                { val: "design_synthetic", label: "Pelle Sintetica", type: "flat", icon: "fa-hand-dots" }
            ],
            "Braccia": [
                { val: "body_forearm_inner", label: "Avambraccio Interno", type: "body", icon: "fa-hand-holding" },
                { val: "body_forearm_outer", label: "Avambraccio Esterno", type: "body", icon: "fa-hand-back-fist" },
                { val: "body_bicep_inner", label: "Bicipite Interno", type: "body", icon: "fa-dumbbell" },
                { val: "body_bicep_outer", label: "Bicipite Est./Spalla", type: "body", icon: "fa-circle-notch" },
                { val: "body_sleeve_full", label: "Manica Intera", type: "body", icon: "fa-shirt" },
                { val: "body_sleeve_half", label: "Mezza Manica", type: "body", icon: "fa-shirt" },
                { val: "body_elbow", label: "Gomito", type: "body", icon: "fa-bullseye" },
                { val: "body_wrist", label: "Polso", type: "body", icon: "fa-stopwatch" }
            ],
            "Torso": [
                { val: "body_chest_center", label: "Sterno", type: "body", icon: "fa-heart-pulse" },
                { val: "body_sternum_under", label: "Sotto-seno (Underboob)", type: "body", icon: "fa-venus" },
                { val: "body_chest_pec", label: "Pettorale", type: "body", icon: "fa-shield-halved" },
                { val: "body_chest_full", label: "Petto Intero", type: "body", icon: "fa-expand" },
                { val: "body_ribs", label: "Costole", type: "body", icon: "fa-lungs" },
                { val: "body_stomach", label: "Ventre/Addome", type: "body", icon: "fa-cube" },
                { val: "body_hip", label: "Fianco/Anca", type: "body", icon: "fa-person-dress" },
                { val: "body_clavicle", label: "Clavicola", type: "body", icon: "fa-bone" }
            ],
            "Schiena": [
                { val: "body_back_upper", label: "Schiena Alta/Scapola", type: "body", icon: "fa-feather" },
                { val: "body_back_lower", label: "Lombare", type: "body", icon: "fa-anchor" },
                { val: "body_back_full", label: "Schiena Intera", type: "body", icon: "fa-child-reaching" },
                { val: "body_spine", label: "Colonna Vertebrale", type: "body", icon: "fa-ellipsis-vertical" }
            ],
            "Gambe": [
                { val: "body_thigh_front", label: "Coscia Anteriore", type: "body", icon: "fa-layer-group" },
                { val: "body_thigh_side", label: "Coscia Laterale", type: "body", icon: "fa-pause" },
                { val: "body_thigh_back", label: "Retro Coscia", type: "body", icon: "fa-pause" },
                { val: "body_knee", label: "Ginocchio", type: "body", icon: "fa-circle" },
                { val: "body_calf", label: "Polpaccio", type: "body", icon: "fa-socks" },
                { val: "body_shin", label: "Stinco", type: "body", icon: "fa-text-height" },
                { val: "body_ankle", label: "Caviglia", type: "body", icon: "fa-shoe-prints" },
                { val: "body_foot_top", label: "Collo del Piede", type: "body", icon: "fa-shoe-prints" }
            ],
            "Testa & Mani": [
                { val: "body_neck_side", label: "Collo (Lato)", type: "body", icon: "fa-user-tie" },
                { val: "body_neck_back", label: "Nuca", type: "body", icon: "fa-user" },
                { val: "body_throat", label: "Gola", type: "body", icon: "fa-microphone-lines" },
                { val: "body_hand_back", label: "Dorso Mano", type: "body", icon: "fa-hand" },
                { val: "body_palm", label: "Palmo", type: "body", icon: "fa-hand-spock" },
                { val: "body_hand_knuckles", label: "Nocche", type: "body", icon: "fa-hand-fist" },
                { val: "body_fingers", label: "Dita", type: "body", icon: "fa-hand-pointer" },
                { val: "body_behind_ear", label: "Dietro Orecchio", type: "body", icon: "fa-ear-listen" },
                { val: "body_face", label: "Viso", type: "body", icon: "fa-face-smile" }
            ]
        };

        // --- INIT & RENDER ---

        window.onload = function() {
            renderCustomOptions('styleSelect-list', stylesData, 'styleSelect');
            renderCustomOptions('contextSelect-list', contextData, 'contextSelect');
            
            // Slider Logic
            const slider = document.getElementById('eccentricitySlider');
            const sliderVal = document.getElementById('sliderValue');
            slider.oninput = function() {
                let text = "Bilanciato";
                if(this.value < 30) text = "Tecnico";
                if(this.value > 70) text = "Visionario";
                sliderVal.textContent = `${text} (${this.value}%)`;
            }
        };

        // --- CUSTOM SELECT LOGIC ---

        function renderCustomOptions(containerId, dataObj, inputId) {
            const container = document.getElementById(containerId);
            
            for (const [category, items] of Object.entries(dataObj)) {
                // Render Category Header
                const catDiv = document.createElement('div');
                catDiv.className = 'select-category';
                catDiv.textContent = category;
                container.appendChild(catDiv);

                // Render Items
                items.forEach(item => {
                    const label = item.label || item.val;
                    const value = item.val; // Value to store
                    const fullObj = item.label ? JSON.stringify(item) : item.val; // Value logic differs for context vs style
                    
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'select-item';
                    itemDiv.innerHTML = `<i class="fa-solid ${item.icon} item-icon"></i> ${label}`;
                    
                    // On click: update display, update hidden input, close dropdown
                    itemDiv.onclick = (e) => {
                        e.stopPropagation();
                        // Update Display Text
                        const displaySpan = document.getElementById(`${inputId}-display`);
                        displaySpan.innerHTML = `<i class="fa-solid ${item.icon} mr-2 text-gold-500"></i> ${label}`;
                        
                        // Update Hidden Input
                        document.getElementById(inputId).value = fullObj;
                        
                        closeAllSelect();
                    };
                    container.appendChild(itemDiv);
                });
            }
        }

        // Helper for static selects (Fix Type & Gender)
        function selectOption(selectId, value, label, iconClass) {
            const displayId = `${selectId}-display`;
            const displayEl = document.getElementById(displayId);
            
            // Only Gender has a display ID that changes text, FixType just updates value usually or text
            if(displayEl) {
                displayEl.innerHTML = `<i class="fa-solid ${iconClass} mr-2 text-gold-500"></i> ${label}`;
            } else {
                 // For FixType which has static text initially
                 const parent = document.getElementById(`${selectId}-container`).querySelector('.select-selected span');
                 parent.innerHTML = `<i class="fa-solid ${iconClass} mr-2 text-gold-500"></i> ${label}`;
            }

            document.getElementById(selectId).value = value;
            closeAllSelect();
        }

        function toggleSelect(e, listId) {
            e.stopPropagation();
            const list = document.getElementById(listId);
            const wasHidden = list.classList.contains('select-hide');
            closeAllSelect(); // Close others
            if (wasHidden) {
                list.classList.remove('select-hide');
            }
        }

        function closeAllSelect(e) {
            const items = document.getElementsByClassName("select-items");
            for (let i = 0; i < items.length; i++) {
                items[i].classList.add("select-hide");
            }
        }

        // --- APP LOGIC ---

        let currentMode = 'new'; 

        function switchTab(mode) {
            currentMode = mode;
            const tabNew = document.getElementById('tab-new');
            const tabFix = document.getElementById('tab-fix');
            const secNew = document.getElementById('section-new');
            const secFix = document.getElementById('section-fix');
            const hint = document.getElementById('uploadHint');

            if (mode === 'new') {
                tabNew.className = "tab-active text-lg font-bold pb-2 uppercase tracking-wide transition-colors border-b-2 border-gold-500 text-gold-500";
                tabFix.className = "tab-inactive text-lg font-bold pb-2 uppercase tracking-wide transition-colors border-b-2 border-transparent text-slate-500 hover:text-slate-300";
                secNew.classList.remove('hidden');
                secFix.classList.add('hidden');
                hint.style.display = 'none';
            } else {
                tabFix.className = "tab-active text-lg font-bold pb-2 uppercase tracking-wide transition-colors border-b-2 border-gold-500 text-gold-500";
                tabNew.className = "tab-inactive text-lg font-bold pb-2 uppercase tracking-wide transition-colors border-b-2 border-transparent text-slate-500 hover:text-slate-300";
                secFix.classList.remove('hidden');
                secNew.classList.add('hidden');
                hint.style.display = 'block';
            }
        }

        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('imagePreview');
                    const placeholder = document.getElementById('uploadPlaceholder');
                    const btn = document.getElementById('removeImageBtn');
                    
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                    btn.classList.remove('hidden');
                }
                reader.readAsDataURL(file);
            }
        }

        function removeImage(event) {
            event.stopPropagation();
            document.getElementById('fileInput').value = "";
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('imagePreview').src = "";
            document.getElementById('uploadPlaceholder').classList.remove('hidden');
            document.getElementById('removeImageBtn').classList.add('hidden');
        }

        function generatePrompt() {
            const style = document.getElementById('styleSelect').value;
            const contextRaw = document.getElementById('contextSelect').value;
            const gender = document.getElementById('genderSelect').value;
            const eccentricity = document.getElementById('eccentricitySlider').value;

            if (!style || !contextRaw) {
                alert("Seleziona Stile e Contesto.");
                return;
            }

            const contextObj = JSON.parse(contextRaw);
            let prompt = "";
            
            // Context String Logic
            let contextString = "";
            
            if (contextObj.type === "body") {
                let genderTerm = gender === "man" ? "male" : (gender === "woman" ? "female" : "person");
                contextString = `tattooed on ${genderTerm} ${translateBodyPart(contextObj.val)}, close up, realistic skin texture`;
            } else if (contextObj.type === "stencil") {
                contextString = "tattoo stencil, purple carbon lines on white paper, outline only, no shading, flat lay, top-down view, 2D plan, no perspective, white background, high contrast";
            } else {
                // OTHER FLAT DESIGNS
                if(contextObj.val.includes("white")) contextString = "clean white background, 2d design, flat vector style, isolated, top-down view";
                else if(contextObj.val.includes("transfer")) contextString = "purple transfer paper texture, hectograph ink style, tattoo stencil";
                else if(contextObj.val.includes("digital")) contextString = "digital art illustration interface, procreate screen style, high definition";
                else contextString = "isolated design, neutral background";
            }

            let creativityKeywords = "";
            if (eccentricity < 30) creativityKeywords = "exact adherence, precise lines, technical drawing";
            else if (eccentricity > 70) creativityKeywords = "avant-garde, visionary art, complex details, artistic freedom";
            else creativityKeywords = "balanced composition, professional tattoo art";

            if (currentMode === 'new') {
                const subject = document.getElementById('subjectInput').value.trim();
                if (!subject) { alert("Descrivi il soggetto."); return; }
                
                if (contextObj.type === "stencil") {
                     prompt = `${style} tattoo design of ${subject}, ${contextString}. ${creativityKeywords}.`;
                } else {
                     prompt = `${style} tattoo design of ${subject}, ${contextString}. ${creativityKeywords}, Masterpiece, 8k resolution, sharp focus.`;
                }
            } else {
                const fixType = document.getElementById('fixTypeSelect').value;
                const fixDesc = document.getElementById('fixInput').value.trim();
                if (!fixDesc || !fixType) { alert("Descrivi la modifica e seleziona il tipo."); return; }

                let actionKeyword = "";
                let technique = "";
                // Mapping keywords based on fixType... (Simulated switch)
                if (fixType === 'coverup') { actionKeyword = "Cover-up"; technique = "heavy shading, blast over style"; }
                else if (fixType === 'rework') { actionKeyword = "Restoration"; technique = "sharpening lines, touch up"; }
                else if (fixType === 'add') { actionKeyword = "Expansion"; technique = "seamless integration"; }
                else { actionKeyword = "Colorizing"; technique = "vibrant color packing"; }

                prompt = `[Image-to-Image] ${actionKeyword}: ${fixDesc}. Style: ${style}. ${technique}. Context: ${contextString}. ${creativityKeywords}, 8k resolution.`;
            }

            document.getElementById('outputPrompt').value = prompt;
        }

        function translateBodyPart(val) {
            // Simplified Mapping for brevity
            const map = {
                "body_forearm_inner": "inner forearm", "body_forearm_outer": "outer forearm",
                "body_sleeve_full": "full arm sleeve", "body_sleeve_half": "half arm sleeve",
                "body_bicep_inner": "inner bicep", "body_bicep_outer": "outer bicep",
                "body_chest_center": "sternum", "body_ribs": "ribs", "body_back_full": "full back",
                "body_back_upper": "upper back", "body_back_lower": "lower back", "body_spine": "spine",
                "body_thigh_front": "front thigh", "body_thigh_side": "side thigh", "body_thigh_back": "back thigh",
                "body_calf": "calf", "body_ankle": "ankle", "body_foot_top": "top of foot",
                "body_neck_side": "neck", "body_neck_back": "back of neck", "body_hand_back": "hand",
                "body_palm": "palm", "body_fingers": "fingers", "body_hand_knuckles": "knuckles",
                "body_behind_ear": "behind ear", "body_face": "face", "body_throat": "throat"
            };
            return map[val] || "skin";
        }

        function copyToClipboard() {
            const copyText = document.getElementById("outputPrompt");
            copyText.select();
            copyText.setSelectionRange(0, 99999); 
            try {
                const successful = document.execCommand('copy');
                if(successful) {
                    const badge = document.getElementById('copySuccess');
                    badge.classList.remove('hidden');
                    badge.classList.remove('opacity-0');
                    setTimeout(() => {
                        badge.classList.add('opacity-0');
                        setTimeout(() => badge.classList.add('hidden'), 300);
                    }, 2000);
                } else { alert("Copia manuale richiesta."); }
            } catch (err) { alert("Errore copia."); }
        }
    </script>
</body>
</html>


